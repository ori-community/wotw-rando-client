#pragma once

#include <Modloader/modloader.h>
#include <Randomizer/archipelago/archipelago_seedgen.h>
#include <Randomizer/randomizer.h>

namespace randomizer::archipelago::seedgen_source_generators {

    // This header places an empty item in every location, so that they are counted in the pickup counter
    const ArchipelagoSeedGeneratorOptionSourceGenerator pickup_count = {
        []() -> std::string { return "pickup_count"; },
        [](const ArchipelagoSeedGeneratorOptions& options) -> std::unordered_set<std::string> {
            return {};
        },
        [](const ArchipelagoSeedGeneratorOptions& options) -> std::optional<std::string> {
            // The location names are hardcoded, but this needs to be rewritten in v5 anyway
            std::unordered_set<std::string> filled_locations_names = {};  // Names of locations containing an AP item

            if (options.location_flags & FLAG_QUESTS) {
                std::vector<std::string> quest_locs = {
                    "MarshSpawn.TokkKeystoneQuest",
                    "MarshSpawn.MokkFangQuest",
                    "MarshSpawn.TokkTabletQuest",
                    "EastHollow.KwolokAmuletQuest",
                    "EastHollow.WellspringDoneTalk",
                    "OuterWellspring.TheLostCompass",
                    "WoodsEntry.TreeSeed",
                    "EastPools.KwolokAmuletQI",
                    "LowerWastes.EerieGemQI",
                    "GladesTown.TwillenGemQuest",
                    "GladesTown.FamilyReunionKey",
                    "GladesTown.MokiAcornQuest",
                };
                filled_locations_names.insert(quest_locs.begin(), quest_locs.end());
            }
            if (options.location_flags & FLAG_HAND_TO_HAND) {
                std::vector<std::string> hand_locs = {
                    "EastHollow.HandToHandMap",
                    "GladesTown.HandToHandPouch",
                    "InnerWellspring.HandToHandHerbs",
                    "LowerReach.HandToHandSoup",
                    "LowerReach.HandToHandHat",
                    "GladesTown.HandToHandLantern",
                    "LowerDepths.HandToHandSilk",
                    "EastPools.HandToHandSpyglass",
                    "GladesTown.HandToHandCanteen",
                    "LowerWastes.HandToHandMapstone",
                    "WindtornRuins.HandToHandComplete",
                };
                filled_locations_names.insert(hand_locs.begin(), hand_locs.end());
            }
            if (options.location_flags & FLAG_REBUILD) {
                std::vector<std::string> rebuild_locs = {
                    "GladesTown.RebuildTheGlades",
                    "GladesTown.RegrowTheGlades",
                };
                filled_locations_names.insert(rebuild_locs.begin(), rebuild_locs.end());
            }
            if (options.location_flags & FLAG_TRIALS) {
                std::vector<std::string> trials_locs = {
                    "MarshPastOpher.SpiritTrial",
                    "WestHollow.SpiritTrial",
                    "OuterWellspring.SpiritTrial",
                    "EastPools.SpiritTrial",
                    "WoodsMain.SpiritTrial",
                    "LowerReach.SpiritTrial",
                    "LowerDepths.SpiritTrial",
                    "LowerWastes.SpiritTrial",
                };
                filled_locations_names.insert(trials_locs.begin(), trials_locs.end());
            }
            if (options.location_flags & FLAG_QOL) {
                std::vector<std::string> qol_locs = {
                    "WoodsEntry.LastTreeBranch",
                };
                filled_locations_names.insert(qol_locs.begin(), qol_locs.end());
            }
            if (options.location_flags & FLAG_MAPS) {
                std::vector<std::string> map_locs = {
                    "MarshSpawn.LupoMap",
                    "MidnightBurrows.LupoMap",
                    "WestHollow.LupoMap",
                    "InnerWellspring.LupoMap",
                    "EastPools.LupoMap",
                    "LowerReach.LupoMap",
                    "LowerDepths.LupoMap",
                    "WillowsEnd.LupoMap",
                    "LowerWastes.LupoMap",
                    "LupoShop.HCMapIcon",
                    "LupoShop.ECMapIcon",
                };
                filled_locations_names.insert(map_locs.begin(), map_locs.end());
            }
            std::vector<std::string> base_locs = {
                "MarshSpawn.CaveKS",
                "MarshSpawn.FangQI",
                "HowlsDen.SwordTree",
                "MidnightBurrows.TabletQI",
                "EastHollow.ForestsVoice",
                "GladesTown.AcornQI",
                "InnerWellspring.NeedleQI",
                "InnerWellspring.BlueMoonSeed",
                "InnerWellspring.WaterEscape",
                "WoodsEntry.DollQI",
                "LowerReach.ForestsMemory",
                "UpperReach.SpringSeed",
                "UpperDepths.LightcatcherSeed",
                "UpperDepths.ForestsEyes",
                "EastPools.GrassSeed",
                "WestPools.ForestsStrength",
                "UpperWastes.FlowersSeed",
                "WindtornRuins.Seir",
                "MarshSpawn.RockHC",
                "MarshSpawn.FirstPickupEX",
                "MarshSpawn.GrappleHC",
                "MarshSpawn.BridgeEX",
                "MarshSpawn.ResilienceShard",
                "MarshSpawn.ResilienceOre",
                "MarshSpawn.BashEC",
                "MarshSpawn.PreLupoEX",
                "MarshSpawn.RegenTree",
                "MarshSpawn.LeverEC",
                "MarshSpawn.LeftTokkEX",
                "MarshSpawn.FightRoomEX",
                "MarshSpawn.CaveOre",
                "MarshSpawn.LongSwimEX",
                "MarshSpawn.BurrowOre",
                "MarshSpawn.LifepactShard",
                "MarshSpawn.BurrowsApproachLedgeEX",
                "MarshSpawn.CrusherSwimEX",
                "MarshSpawn.RecklessShard",
                "MarshSpawn.MokkEX",
                "MarshSpawn.FangEC",
                "MarshSpawn.DamageTree",
                "MarshSpawn.PoolsPathEX",
                "MidnightBurrows.LeftKS",
                "MidnightBurrows.RightKS",
                "MidnightBurrows.UpperKS",
                "MidnightBurrows.LowerKS",
                "MidnightBurrows.DeflectorShard",
                "HowlsDen.RightHC",
                "HowlsDen.LeftHC",
                "HowlsDen.AboveDoorKS",
                "HowlsDen.MagnetShard",
                "HowlsDen.BoneOre",
                "HowlsDen.AboveTPEX",
                "HowlsDen.LaserKS",
                "HowlsDen.CombatShrine",
                "HowlsDen.DoubleJumpEX",
                "HowlsDen.StickyShard",
                "HowlsDen.DoubleJumpTree",
                "MarshPastOpher.TrialLeftEX",
                "MarshPastOpher.TrialOre",
                "MarshPastOpher.TrialEC",
                "MarshPastOpher.TrialHC",
                "MarshPastOpher.TrialRightEX",
                "MarshPastOpher.CombatShrine",
                "MarshPastOpher.SwingPoleEX",
                "MarshPastOpher.LeftEyestone",
                "MarshPastOpher.RightEyestone",
                "MarshPastOpher.BowEC",
                "MarshPastOpher.BowTree",
                "MarshPastOpher.CeilingEX",
                "MarshPastOpher.PoolsPathEC",
                "MarshPastOpher.PoolsPathEX",
                "WestHollow.CrusherHC",
                "WestHollow.FarLeftEX",
                "WestHollow.RockPuzzleEX",
                "WestHollow.HiddenEC",
                "WestHollow.QuickshotShard",
                "WestHollow.SwimEC",
                "WestHollow.TrialHC",
                "WestHollow.FallingSlugEX",
                "WestHollow.AboveDashEX",
                "WestHollow.DashRightEX",
                "WestHollow.CrusherEX",
                "WestHollow.DashTree",
                "EastHollow.GladesApproachOre",
                "EastHollow.HornBeetleFightEX",
                "EastHollow.SpikeLanternEX",
                "EastHollow.SecretRoofEX",
                "EastHollow.MortarEX",
                "EastHollow.BashEC",
                "EastHollow.BashHC",
                "EastHollow.BashEX",
                "EastHollow.BashTree",
                "EastHollow.RightKwolokEX",
                "EastHollow.SilentSwimEC",
                "EastHollow.SplinterShard",
                "EastHollow.KwolokSwimOre",
                "EastHollow.KwolokSwimLeftEX",
                "EastHollow.KwolokSwimRightEX",
                "EastHollow.DepthsExteriorEX",
                "GladesTown.HoleHutEC",
                "GladesTown.AboveGromHC",
                "GladesTown.LupoSwimHC",
                "GladesTown.UpperOre",
                "GladesTown.LowerOre",
                "GladesTown.ArcingShard",
                "GladesTown.BountyShard",
                "GladesTown.LupoSoupEX",
                "GladesTown.BraveMokiHutEX",
                "GladesTown.MotayHutEX",
                "GladesTown.HoleHutEX",
                "GladesTown.UpperLeftEX",
                "GladesTown.LupoSwimMiddleEX",
                "GladesTown.CaveBurrowEX",
                "GladesTown.BelowHoleHutEX",
                "GladesTown.KeyMokiHutEX",
                "GladesTown.AboveTpEX",
                "GladesTown.AboveCaveEX",
                "GladesTown.LupoSwimLeftEX",
                "GladesTown.UpdraftCeilingEX",
                "GladesTown.LeafPileEX",
                "GladesTown.DamageTree",
                "WestGlades.GrappleEX",
                "WestGlades.AbovePlantEX",
                "WestGlades.LowerPoolEX",
                "WestGlades.UpperPoolEX",
                "WestGlades.SwimEC",
                "WestGlades.LeftOre",
                "WestGlades.RightOre",
                "WestGlades.ShrineHC",
                "WestGlades.CombatShrine",
                "OuterWellspring.RightWallOre",
                "OuterWellspring.RightWallEC",
                "OuterWellspring.RightWallEX",
                "OuterWellspring.TrialOre",
                "OuterWellspring.UltraGrappleShard",
                "OuterWellspring.HiddenHC",
                "OuterWellspring.EntranceRoofEX",
                "OuterWellspring.WheelEX",
                "OuterWellspring.BasementEC",
                "OuterWellspring.LifeHarvestShard",
                "OuterWellspring.SwimEX",
                "OuterWellspring.SwimOre",
                "InnerWellspring.ThornShard",
                "InnerWellspring.ThornEX",
                "InnerWellspring.ThreeWheelsEX",
                "InnerWellspring.WaterSwitchEX",
                "InnerWellspring.DrainHC",
                "InnerWellspring.DrainEX",
                "InnerWellspring.LaserOre",
                "InnerWellspring.LeverEC",
                "InnerWellspring.LupoEX",
                "InnerWellspring.ShortcutWheelEX",
                "InnerWellspring.GrappleTreeEX",
                "InnerWellspring.GrappleTree",
                "InnerWellspring.AboveSpinArenaEX",
                "InnerWellspring.RotateRoomEX",
                "InnerWellspring.RotateRoomOre",
                "InnerWellspring.LibraryEX",
                "InnerWellspring.AboveTpEX",
                "InnerWellspring.SwimOre",
                "InnerWellspring.EscapeRevisitEX",
                "PoolsApproach.MarshPathCurrentEX",
                "PoolsApproach.AboveWheelEX",
                "PoolsApproach.MillPathHC",
                "PoolsApproach.MillPathEC",
                "PoolsApproach.MillPathEX",
                "EastPools.RightOre",
                "EastPools.TwoCrushersEX",
                "EastPools.BubbleCurrentEX",
                "EastPools.BelowLeverEX",
                "EastPools.AboveDoorOre",
                "EastPools.PurpleWallHC",
                "EastPools.AboveTpEX",
                "EastPools.LupoOre",
                "EastPools.UltraBashShard",
                "EastPools.FightRoomHC",
                "EastPools.EnergyHarvestShard",
                "EastPools.LupoEX",
                "EastPools.BehindCrusherEX",
                "UpperPools.LowerKS",
                "UpperPools.UpperLeftKS",
                "UpperPools.UpperMidKS",
                "UpperPools.UpperRightKS",
                "UpperPools.FishPoolEX",
                "UpperPools.FishPoolOre",
                "UpperPools.BubblesEC",
                "UpperPools.RightBubblesEX",
                "UpperPools.LeftBubblesEX",
                "UpperPools.SwimDashTree",
                "UpperPools.SwimDashCurrentEX",
                "UpperPools.RoofEX",
                "UpperPools.WaterfallEC",
                "WestPools.BurrowEX",
                "WestPools.BurrowOre",
                "WestPools.TpEX",
                "WestPools.EscapeRevisitEX",
                "WoodsEntry.MudPitEX",
                "WoodsEntry.LedgeOre",
                "WoodsEntry.LeafPileEX",
                "WoodsEntry.TpEX",
                "WoodsEntry.LowerKS",
                "WoodsEntry.UpperKS",
                "WoodsMain.RightKS",
                "WoodsMain.UpperKS",
                "WoodsMain.LeftKS",
                "WoodsMain.LowerKS",
                "WoodsMain.BehindWallOre",
                "WoodsMain.LowerLeafPileEX",
                "WoodsMain.MiddleLeafPileEX",
                "WoodsMain.UpperLeafPileEX",
                "WoodsMain.YellowWallEX",
                "WoodsMain.HiddenOre",
                "WoodsMain.HiddenEX",
                "WoodsMain.BelowKeystonesEX",
                "WoodsMain.BehindDoorRoofEX",
                "WoodsMain.PetrifiedHowlEX",
                "WoodsMain.OverflowShard",
                "WoodsMain.CombatShrine",
                "WoodsMain.ShrineEX",
                "WoodsMain.FeedingGroundsEX",
                "LowerReach.BelowBaurEX",
                "LowerReach.AboveBaurLowerEX",
                "LowerReach.AboveBaurUpperEX",
                "LowerReach.IcefallOre",
                "LowerReach.IcefallEX",
                "LowerReach.AboveDoorEX",
                "LowerReach.HiddenOre",
                "LowerReach.MeltIceEX",
                "LowerReach.BurrowEX",
                "LowerReach.TPLeftEX",
                "LowerReach.BelowLupoEX",
                "LowerReach.BreakWallEX",
                "LowerReach.WindBottomEX",
                "LowerReach.WindHiddenEX",
                "LowerReach.SnowballHC",
                "LowerReach.RoofLeftEX",
                "LowerReach.RoofRightEX",
                "LowerReach.FractureShard",
                "LowerReach.EscapeRevisitEX",
                "LowerReach.RightKS",
                "LowerReach.UpperLeftKS",
                "LowerReach.MiddleLeftKS",
                "LowerReach.BottomLeftKS",
                "LowerReach.TrialEX",
                "LowerReach.CatalystShard",
                "UpperReach.LifeForceShard",
                "UpperReach.LifeForceEX",
                "UpperReach.LowerKS",
                "UpperReach.UpperKS",
                "UpperReach.MiddleLeftKS",
                "UpperReach.MiddleRightKS",
                "UpperReach.SoupOre",
                "UpperReach.SwingPoleEX",
                "UpperReach.SwimEX",
                "UpperReach.LightBurstTree",
                "UpperReach.TreeOre",
                "UpperReach.WellEX",
                "UpperReach.HiddenEX",
                "UpperDepths.EntrySpikesEX",
                "UpperDepths.EntryRoofEX",
                "UpperDepths.EntryOre",
                "UpperDepths.RightEntryKS",
                "UpperDepths.LeftEntryKS",
                "UpperDepths.SwimEC",
                "UpperDepths.TeleporterEX",
                "UpperDepths.LeftHealthKS",
                "UpperDepths.RightHealthKS",
                "UpperDepths.BossPathEX",
                "UpperDepths.KeystoneHC",
                "UpperDepths.HiveEX",
                "LowerDepths.RaceStartHC",
                "LowerDepths.BelowDoorOre",
                "LowerDepths.SpiritSurgeShard",
                "LowerDepths.CombatShrine",
                "LowerDepths.SwimEC",
                "LowerDepths.LeftEX",
                "LowerDepths.RightEX",
                "LowerDepths.FlashTree",
                "LowerWastes.WestTPOre",
                "LowerWastes.PurpleWallEX",
                "LowerWastes.SunsetViewEX",
                "LowerWastes.SandBridgeOre",
                "LowerWastes.MuncherTunnelEC",
                "LowerWastes.SandPotHC",
                "LowerWastes.SandPotEX",
                "LowerWastes.MuncherPitEX",
                "LowerWastes.BottomRightEX",
                "LowerWastes.BottomRightHC",
                "LowerWastes.LastStandShard",
                "LowerWastes.LastStandEX",
                "LowerWastes.MuncherClimbEX",
                "LowerWastes.SkeetoHiveEX",
                "LowerWastes.BurrowTree",
                "LowerWastes.BurrowTreeEX",
                "LowerWastes.UpperPathEC",
                "LowerWastes.UpperPathEX",
                "LowerWastes.UpperPathHiddenEX",
                "LowerWastes.UpperPathHC",
                "LowerWastes.EastTPOre",
                "UpperWastes.LowerKS",
                "UpperWastes.UpperKS",
                "UpperWastes.TurmoilShard",
                "UpperWastes.KSDoorEX",
                "UpperWastes.LedgeEC",
                "UpperWastes.MissileSpawnEX",
                "UpperWastes.PurpleWallEX",
                "UpperWastes.PurpleWallHC",
                "UpperWastes.RoofEX",
                "UpperWastes.SpinLasersRightEX",
                "UpperWastes.SpinLasersMiddleEX",
                "UpperWastes.SpinLasersLowerEX",
                "UpperWastes.WallOre",
                "WindtornRuins.EscapeRevisitEC",
                "WeepingRidge.Ore",
                "WeepingRidge.LaunchTree",
                "WeepingRidge.SpikeClimbEX",
                "WeepingRidge.PortalEX",
                "WillowsEnd.SpikesOre",
                "WillowsEnd.EntryEX",
                "WillowsEnd.PoisonfallHC",
                "WillowsEnd.WindSpinOre",
                "WillowsEnd.RedirectEX",
                "WillowsEnd.UpperLeftEX",
                "WillowsEnd.UpperRightEX",
                "TwillenShop.Overcharge",
                "TwillenShop.TripleJump",
                "TwillenShop.Wingclip",
                "TwillenShop.Swap",
                "TwillenShop.LightHarvest",
                "TwillenShop.Vitality",
                "TwillenShop.Energy",
                "TwillenShop.Finesse",
                "OpherShop.WaterBreath",
                "OpherShop.Spike",
                "OpherShop.SpiritSmash",
                "OpherShop.Teleport",
                "OpherShop.SpiritStar",
                "OpherShop.Blaze",
                "OpherShop.Sentry",
                "OpherShop.ExplodingSpike",
                "OpherShop.ShockSmash",
                "OpherShop.StaticStar",
                "OpherShop.ChargeBlaze",
                "OpherShop.RapidSentry",
                "LupoShop.ShardMapIcon",
            };
            filled_locations_names.insert(base_locs.begin(), base_locs.end());

            std::string output;
            for (auto& location_name: filled_locations_names) {
                const auto location = location_collection().location(location_name);
                if (location.has_value()) {
                    const auto loc = location.value();
                    const int group = loc.condition.state.group_int();
                    const int state = loc.condition.state.state();
                    const int value = loc.condition.lower_bound_value();

                    if (value == 1) {
                        output += std::format("{}|{}|6|\n", group, state);
                    }
                    else {
                        output += std::format("{}|{}>={}|6|\n", group, state, value);
                    }
                }
                else {
                    modloader::error("archipelago", std::format("Location {} doesn't exist", location_name));
                }
            }
            return output;
        },
    };
}
