#include <Randomizer/constants.h>

#include <Common/ext.h>

#include <Modloader/app/methods/Moon/uberSerializationWisp/PlayerUberStateAreaMapInformation.h>
#include <Modloader/app/types/GameWorld.h>
#include <Modloader/interception.h>
#include <Modloader/interception_macros.h>


#include <Randomizer/seed/seed.h>

#include <fstream>
#include <Core/api/game/player.h>
#include <Core/api/uber_states/uber_state_virtual.h>
#include <Randomizer/features/area_segment_states.h>

using namespace app::classes;

namespace randomizer::area_segment_states {
    // GameWorldArea ID * 10000 + face ID
#pragma region Uber State IDs
    const std::vector<int> segment_uber_state_ids = {
        12697,
        12701,
        12712,
        12778,
        12780,
        12788,
        12791,
        12796,
        12804,
        12805,
        12808,
        12815,
        12818,
        12821,
        12855,
        12872,
        12886,
        12895,
        12896,
        13044,
        13047,
        13063,
        13074,
        13077,
        13088,
        13421,
        13424,
        13437,
        13442,
        13458,
        13664,
        13672,
        13673,
        13677,
        13679,
        13680,
        13684,
        13690,
        13768,
        13774,
        13777,
        13854,
        13915,
        13922,
        13928,
        13929,
        13932,
        13945,
        13946,
        14061,
        14101,
        14106,
        14109,
        14113,
        14119,
        14124,
        14127,
        14130,
        14136,
        14142,
        14143,
        14146,
        14160,
        14163,
        14165,
        14173,
        14174,
        14176,
        14178,
        14198,
        14207,
        14213,
        14214,
        14215,
        14219,
        14220,
        14224,
        14225,
        14231,
        14232,
        14235,
        14239,
        14248,
        14256,
        14258,
        14259,
        14263,
        14269,
        14272,
        14275,
        14278,
        14280,
        14285,
        14287,
        14289,
        14298,
        14299,
        14311,
        14315,
        14330,
        14332,
        14336,
        14337,
        14344,
        14362,
        14390,
        14393,
        14396,
        14400,
        14403,
        14405,
        14416,
        14420,
        14421,
        14424,
        14425,
        14428,
        14429,
        14462,
        14467,
        14479,
        14483,
        14484,
        14491,
        14494,
        14499,
        14505,
        14513,
        14517,
        14518,
        14520,
        14522,
        14527,
        14544,
        14553,
        14558,
        14562,
        14563,
        14565,
        14587,
        14588,
        14592,
        14593,
        14598,
        14599,
        14615,
        14618,
        14622,
        14627,
        14628,
        14629,
        14632,
        14633,
        14640,
        14641,
        14642,
        14646,
        14647,
        14657,
        14658,
        14659,
        14661,
        14665,
        14678,
        14687,
        14694,
        14708,
        14713,
        14716,
        14717,
        14733,
        14736,
        14739,
        14742,
        14745,
        14753,
        14759,
        14761,
        14763,
        14764,
        14765,
        14787,
        14789,
        14790,
        14792,
        14793,
        14794,
        14795,
        14797,
        14800,
        14802,
        14803,
        14807,
        14808,
        14809,
        25221,
        25234,
        25235,
        25240,
        25242,
        25246,
        25255,
        25261,
        25281,
        25282,
        25286,
        25289,
        25293,
        25297,
        25298,
        25299,
        25301,
        25303,
        25315,
        25316,
        25317,
        25323,
        25326,
        25329,
        25331,
        25332,
        25348,
        25351,
        25352,
        25355,
        25360,
        25361,
        25365,
        25368,
        25371,
        25376,
        25377,
        25380,
        25386,
        25389,
        25395,
        25398,
        25402,
        25405,
        25407,
        25408,
        25411,
        25414,
        25417,
        25422,
        25426,
        25431,
        25432,
        25433,
        25435,
        25439,
        25442,
        25444,
        25445,
        25451,
        25455,
        25458,
        25464,
        25466,
        25467,
        25470,
        25473,
        25474,
        25478,
        25491,
        25497,
        25498,
        25501,
        25504,
        25507,
        25512,
        25513,
        25514,
        25517,
        25520,
        25523,
        25527,
        25530,
        25533,
        25536,
        25538,
        25539,
        25542,
        25546,
        25547,
        25556,
        25559,
        25561,
        25564,
        25565,
        25566,
        25570,
        25571,
        25574,
        25580,
        25589,
        35106,
        35107,
        35110,
        35112,
        35116,
        35125,
        35131,
        35134,
        35137,
        35145,
        35151,
        35152,
        35153,
        35156,
        35158,
        35168,
        35169,
        35173,
        35176,
        35191,
        35192,
        35197,
        35198,
        35203,
        35209,
        35217,
        35218,
        35221,
        35225,
        35226,
        35229,
        35232,
        35248,
        35250,
        35253,
        35254,
        35259,
        35263,
        35265,
        35274,
        35281,
        35282,
        35285,
        35286,
        35287,
        35288,
        35290,
        35291,
        35292,
        35304,
        35307,
        45347,
        45354,
        45355,
        45357,
        45426,
        45433,
        45438,
        45450,
        45451,
        45452,
        45453,
        45457,
        45458,
        45460,
        45461,
        45516,
        45519,
        45520,
        45521,
        45523,
        45564,
        45602,
        45603,
        45605,
        45611,
        45622,
        45623,
        45645,
        45649,
        45651,
        45654,
        45660,
        45661,
        45663,
        45765,
        45769,
        45774,
        45854,
        45857,
        45858,
        45861,
        45863,
        45864,
        45872,
        45877,
        45878,
        45886,
        45901,
        45904,
        45907,
        45908,
        45909,
        45943,
        45945,
        45947,
        45960,
        45962,
        45966,
        45986,
        45987,
        46019,
        46020,
        46021,
        46022,
        46023,
        46028,
        46029,
        46030,
        46031,
        46032,
        46033,
        46035,
        46039,
        46045,
        46046,
        46098,
        46099,
        46100,
        46101,
        46103,
        46104,
        46105,
        46107,
        46108,
        46109,
        46110,
        46111,
        46114,
        46115,
        46116,
        46118,
        46127,
        54624,
        54635,
        54639,
        54642,
        54656,
        54666,
        54669,
        54672,
        54673,
        54676,
        54677,
        54809,
        54817,
        66940,
        66943,
        66946,
        66949,
        66956,
        66957,
        66964,
        66967,
        66974,
        66977,
        67001,
        67004,
        67010,
        67011,
        67015,
        67018,
        67020,
        67023,
        67026,
        67029,
        67032,
        67034,
        67035,
        67175,
        67178,
        67181,
        67190,
        67197,
        67202,
        67205,
        67206,
        67207,
        67208,
        67209,
        67212,
        67213,
        67216,
        67219,
        67223,
        67226,
        67231,
        67232,
        67240,
        67243,
        67246,
        67249,
        67259,
        67260,
        67268,
        67269,
        67272,
        67275,
        67279,
        67283,
        67286,
        67292,
        67296,
        67299,
        67303,
        67305,
        67308,
        67311,
        67314,
        67317,
        67320,
        67329,
        67330,
        67336,
        67337,
        67342,
        67354,
        67355,
        67356,
        67358,
        67361,
        67364,
        67378,
        67379,
        67381,
        67385,
        67388,
        67394,
        67395,
        67396,
        67404,
        67413,
        67414,
        67415,
        67421,
        67432,
        67433,
        67442,
        67443,
        67445,
        67446,
        67448,
        67450,
        67454,
        67455,
        67458,
        67459,
        75367,
        75368,
        75370,
        75380,
        75390,
        75391,
        75392,
        75406,
        75408,
        75412,
        75415,
        75423,
        75427,
        75429,
        75431,
        75433,
        75434,
        75438,
        75444,
        75454,
        75463,
        75479,
        75485,
        75494,
        75498,
        75500,
        75506,
        75509,
        75512,
        75513,
        75516,
        75538,
        75545,
        75580,
        75589,
        75595,
        75601,
        75611,
        75612,
        75615,
        75616,
        75631,
        75646,
        75649,
        75652,
        75655,
        75658,
        75664,
        75667,
        75670,
        75674,
        75707,
        75709,
        75712,
        75716,
        75721,
        75722,
        75733,
        75735,
        75737,
        75740,
        75747,
        75765,
        75766,
        75776,
        75827,
        75828,
        75829,
        75830,
        75850,
        75854,
        75862,
        75863,
        75864,
        75866,
        75869,
        75872,
        75873,
        75874,
        75877,
        75880,
        75884,
        75886,
        75896,
        75900,
        75901,
        75905,
        75906,
        75907,
        75913,
        75914,
        75917,
        75918,
        75919,
        75920,
        75922,
        75932,
        75938,
        75940,
        75942,
        75947,
        84791,
        85740,
        85800,
        85961,
        85962,
        85968,
        85974,
        85975,
        85976,
        85992,
        86000,
        86001,
        86003,
        86005,
        86012,
        86014,
        86019,
        86022,
        86028,
        86030,
        86031,
        86034,
        86035,
        86036,
        86043,
        86047,
        86056,
        86064,
        86070,
        86072,
        86073,
        86075,
        86076,
        86077,
        86081,
        86087,
        86091,
        86094,
        86100,
        86104,
        86119,
        86120,
        86123,
        86126,
        86127,
        86128,
        86130,
        86131,
        86135,
        86137,
        86138,
        86139,
        86141,
        86143,
        86145,
        86148,
        86178,
        86185,
        86189,
        86192,
        86196,
        86198,
        86199,
        86203,
        86206,
        86207,
        86269,
        86270,
        86274,
        86275,
        86278,
        86285,
        86286,
        86289,
        86292,
        86299,
        86300,
        86301,
        86306,
        86309,
        86311,
        86314,
        86317,
        86320,
        86324,
        86327,
        86334,
        86335,
        86342,
        86345,
        86346,
        86347,
        86351,
        86358,
        86362,
        86365,
        86366,
        86368,
        86370,
        86371,
        86372,
        86375,
        86376,
        86378,
        94218,
        94236,
        94238,
        94264,
        94282,
        94284,
        94290,
        94292,
        94299,
        94329,
        94332,
        94335,
        94524,
        94528,
        94542,
        94554,
        94555,
        94559,
        94562,
        94569,
        94576,
        94579,
        94601,
        94604,
        94606,
        94607,
        94643,
        94666,
        94736,
        94744,
        94757,
        94758,
        94759,
        94761,
        94768,
        94774,
        94777,
        94791,
        94796,
        94799,
        94838,
        94839,
        94874,
        94875,
        94880,
        94882,
        94883,
        94908,
        94911,
        94914,
        94927,
        94930,
        94936,
        94937,
        94939,
        94945,
        94946,
        94947,
        94950,
        94953,
        94957,
        94958,
        94960,
        94961,
        94962,
        94965,
        94967,
        94969,
        94971,
        94973,
        94985,
        94986,
        94989,
        94990,
        94995,
        94998,
        95004,
        95007,
        95013,
        95014,
        95015,
        95017,
        95021,
        95025,
        95027,
        95029,
        95030,
        95032,
        95038,
        95047,
        95052,
        95053,
        95063,
        95067,
        95068,
        95073,
        95076,
        95077,
        95078,
        95079,
        95082,
        95083,
        95085,
        95086,
        95087,
        116003,
        116046,
        116047,
        116048,
        116049,
        116050,
        116051,
        116052,
        116053,
        116054,
        116055,
        116056,
        116057,
        116058,
        116059,
        116060,
        116061,
        116062,
        116064,
        116065,
        116066,
        116067,
        116069,
        116070,
        116071,
        116073,
        116074,
        116075,
        116076,
        116077,
        116078,
        116079,
        116080,
        116082,
        116083,
        116084,
        116086,
        116088,
        116090,
        116091,
        116092,
        116093,
        116094,
        116095,
        116096,
        116097,
        116098,
        116099,
        116100,
        116101,
        116102,
        116103,
        116104,
        116105,
        116106,
        116107,
        116108,
        116109,
        116110,
        116111,
        116112,
        116113,
        116114,
        116115,
        116117,
        116118,
        116119,
        116121,
        116123,
        116124,
        116125,
        135434,
        135443,
        135448,
        135452,
        135456,
        135460,
        135463,
        135466,
        135469,
        135472,
        135476,
        135478,
        135484,
        135487,
        135490,
        135493,
        135496,
        135499,
        135502,
        135505,
        135508,
        135512,
        135515,
        135518,
        135535,
        135557,
        135558,
        135559,
        135582,
        135603,
        135604,
        135605,
        135606,
        135607,
        135608,
        135609,
        135610,
        135611,
        135612,
        135613,
        135614,
        146047,
        146051,
        146060,
        146063,
        146066,
        146069,
        146071,
        146075,
        146078,
        146081,
        146085,
        146089,
        146090,
        146094,
        146097,
        146100,
        146103,
        146106,
        146107,
        146110,
        146113,
        146116,
        146117,
        146124,
        146126,
        146129,
        146135,
        146138,
        146144,
        146146,
        146150,
        146153,
        146156,
        146160,
        146161,
        146163,
        146164,
        146168,
        146171,
        146174,
        146177,
        146180,
        146207,
        146219,
        146222,
        146224,
        146225,
        146231,
        146234,
        146238,
        146239,
        146242,
        146245,
        146248,
        146251,
        146255,
        146259,
        146261,
        146268,
        146271,
        146274,
        146278,
        146280,
        146286,
        146287,
        146291,
        146292,
        146293,
        146329,
        146330,
        146331,
        146363,
        146366,
        146369,
        146376,
        146377,
        146380,
        146383,
        146385,
        146386,
        146432,
        146444,
        146447,
        146450,
        146452,
        146460,
        146466,
        146468,
        146473,
    };
#pragma endregion

    app::WorldMapAreaState__Enum double_to_world_map_area_state(const double& value) {
        if (value < 0.5) {
            return app::WorldMapAreaState__Enum::Hidden;
        }

        if (value < 1.5) {
            return app::WorldMapAreaState__Enum::Discovered;
        }

        return app::WorldMapAreaState__Enum::Visited;
    }

    void register_virtual_uber_states() {
        for (const auto& state_id: segment_uber_state_ids) {
            auto area_id = static_cast<app::GameWorldAreaID__Enum>(state_id / 10000);
            auto face_id = state_id % 10000;

            core::api::uber_states::register_virtual_state(
                {
                    .type = ValueType::Byte,
                    .group = UberStateGroup::MapSegments,
                    .state = state_id,
                    .name = std::format("segment{}", state_id),
                },
                core::Property<double>(
                    [area_id, face_id](auto value) {
                        const auto info = core::api::game::player::get_area_map_information();

                        if (info == nullptr) {
                            return;
                        }

                        Moon::uberSerializationWisp::PlayerUberStateAreaMapInformation::SetAreaState(
                            info,
                            area_id,
                            face_id,
                            double_to_world_map_area_state(value),
                            app::Vector3{0, 0, 0}
                        );
                    },
                    [area_id, face_id]() {
                        const auto info = core::api::game::player::get_area_map_information();

                        if (info == nullptr) {
                            return 0.0;
                        }

                        return static_cast<double>(Moon::uberSerializationWisp::PlayerUberStateAreaMapInformation::GetAreaState(info, area_id, face_id));
                    }
                )
            );
        }
    }

    IL2CPP_INTERCEPT_WITH_ORDER(100, void, Moon::uberSerializationWisp::PlayerUberStateAreaMapInformation, SetAreaState, app::PlayerUberStateAreaMapInformation * this_ptr, app::GameWorldAreaID__Enum area_id, int index, app::WorldMapAreaState__Enum state, app::Vector3 position) {
        const auto virtual_state_id = static_cast<int>(area_id) * 10000 + index;
        const auto uber_state = core::api::uber_states::UberState(UberStateGroup::MapSegments, virtual_state_id);
        const auto previous_value = uber_state.get<double>();

        next::Moon::uberSerializationWisp::PlayerUberStateAreaMapInformation::SetAreaState(this_ptr, area_id, index, state, position);

        const core::api::uber_states::UberStateCallbackParams params{uber_state, previous_value, uber_state.get<double>()};
        core::api::uber_states::notification_bus().trigger_event(params);
        core::api::uber_states::single_notification_bus().trigger_event(uber_state, params);
    }
} // namespace
