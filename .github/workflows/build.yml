name: build

on:
  push:
    branches:
      - '*'
    tags:
      - '*'

permissions:
  packages: write

jobs:
  build:
    runs-on: windows-2025

    env:
      WORKDIR: D:/build
      SCCACHE_GHA_ENABLED: "true"
      USERNAME: ori-community
      VCPKG_EXE: C:/vcpkg/vcpkg
      FEED_URL: https://nuget.pkg.github.com/ori-community/index.json
      VCPKG_BINARY_SOURCES: "clear;nuget,https://nuget.pkg.github.com/ori-community/index.json,readwrite"

    steps:
      - name: Enable Git support for long file paths
        run: git config --system core.longpaths true
      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Install CMake
        run: choco install cmake
      - name: Install Ninja
        run: choco install ninja
      - name: Set up directories
        run: "md -Path 'C:\\moon\\randomizer'"
      - name: Check out repository code
        uses: actions/checkout@v4
      - uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');
      - name: Symlink build directory
        run: |
          $path = Resolve-Path .
          New-Item -Path ${{ env.WORKDIR }} -ItemType SymbolicLink -Value $path
      - uses: ilammy/msvc-dev-cmd@v1
      - name: Bootstrap vcpkg
        shell: pwsh
        run: |
          cd C:/vcpkg
          git pull
          ./bootstrap-vcpkg.bat
      - name: Add NuGet sources
        shell: pwsh
        run: |
          .$(${{ env.VCPKG_EXE }} fetch nuget) `
            sources add `
            -Source "${{ env.FEED_URL }}" `
            -StorePasswordInClearText `
            -Name GitHubPackages `
            -UserName "${{ env.USERNAME }}" `
            -Password "${{ secrets.GITHUB_TOKEN }}"
          .$(${{ env.VCPKG_EXE }} fetch nuget) `
            setapikey "${{ secrets.GITHUB_TOKEN }}" `
            -Source "${{ env.FEED_URL }}"
      - name: Generate solution
        shell: cmd
        working-directory: ${{ env.WORKDIR }}
        run: |
          generate-cmake.release-ninja.bat
          IF ERRORLEVEL 1 (
            echo GENERATING FAILED
            exit 1
          )
      - name: Compile Wotw Rando
        shell: cmd
        working-directory: ${{ env.WORKDIR }}
        run: |
          cmake --build cmake-build-relwithdebinfo --target INSTALL_RUNTIME --config RelWithDebInfo
          IF ERRORLEVEL 1 (
            echo BUILD FAILED
            exit 1
          )
      - name: Archive randomizer
        uses: actions/upload-artifact@v4
        with:
          name: randomizer
          path: 'C:\moon\randomizer\*'
